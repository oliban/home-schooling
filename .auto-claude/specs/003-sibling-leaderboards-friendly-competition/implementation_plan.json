{
  "feature": "Sibling Leaderboards & Friendly Competition",
  "workflow_type": "feature",
  "workflow_rationale": "New feature adding family-only leaderboards with parent-controlled opt-in/opt-out and collaborative challenges. Requires database schema changes, new API endpoints, ranking calculation logic, and UI components. Follows feature workflow: database → backend → frontend → integration.",

  "phases": [
    {
      "id": "phase-1-database",
      "name": "Database Schema",
      "type": "setup",
      "description": "Add database columns and tables for leaderboard opt-in status and family challenges",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add leaderboard_enabled column to children table",
          "service": "backend",
          "files_to_modify": ["backend/src/data/schema.sql"],
          "files_to_create": [],
          "patterns_from": ["backend/src/data/schema.sql"],
          "verification": {
            "type": "command",
            "command": "cd backend && sqlite3 ../data/teacher.db '.schema children' | grep leaderboard_enabled",
            "expected": "leaderboard_enabled"
          },
          "status": "pending",
          "notes": "Add column: leaderboard_enabled INTEGER DEFAULT 0 (opt-in required). Run migration in database.ts."
        },
        {
          "id": "subtask-1-2",
          "description": "Create family_challenges table",
          "service": "backend",
          "files_to_modify": ["backend/src/data/schema.sql"],
          "files_to_create": [],
          "patterns_from": ["backend/src/data/schema.sql"],
          "verification": {
            "type": "command",
            "command": "cd backend && sqlite3 ../data/teacher.db '.schema family_challenges'",
            "expected": "CREATE TABLE"
          },
          "status": "pending",
          "notes": "Table fields: id, name, description, goal_amount, bonus_coins, active, start_date, end_date, created_at"
        },
        {
          "id": "subtask-1-3",
          "description": "Create family_challenge_progress table",
          "service": "backend",
          "files_to_modify": ["backend/src/data/schema.sql"],
          "files_to_create": [],
          "patterns_from": ["backend/src/data/schema.sql"],
          "verification": {
            "type": "command",
            "command": "cd backend && sqlite3 ../data/teacher.db '.schema family_challenge_progress'",
            "expected": "CREATE TABLE"
          },
          "status": "pending",
          "notes": "Table fields: id, challenge_id, parent_id, completed, completed_at. Track completion per family."
        },
        {
          "id": "subtask-1-4",
          "description": "Add database indexes for leaderboard queries",
          "service": "backend",
          "files_to_modify": ["backend/src/data/schema.sql"],
          "files_to_create": [],
          "patterns_from": ["backend/src/data/schema.sql"],
          "verification": {
            "type": "command",
            "command": "cd backend && sqlite3 ../data/teacher.db '.indexes children' | grep leaderboard",
            "expected": "idx_children_leaderboard"
          },
          "status": "pending",
          "notes": "Add index on (parent_id, leaderboard_enabled) for efficient filtering"
        },
        {
          "id": "subtask-1-5",
          "description": "Run database migrations",
          "service": "backend",
          "files_to_modify": ["backend/src/data/database.ts"],
          "files_to_create": [],
          "patterns_from": ["backend/src/data/database.ts"],
          "verification": {
            "type": "command",
            "command": "cd backend && npm run dev",
            "expected": "Server running"
          },
          "status": "pending",
          "notes": "Add migration logic to runMigrations() method following existing family_code migration pattern"
        }
      ]
    },
    {
      "id": "phase-2-backend-leaderboard",
      "name": "Backend Leaderboard Service",
      "type": "implementation",
      "description": "Create leaderboard service with ranking calculation and privacy filtering",
      "depends_on": ["phase-1-database"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create leaderboardService.ts with ranking calculation",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["backend/src/services/leaderboardService.ts"],
          "patterns_from": ["backend/src/routes/children.ts"],
          "verification": {
            "type": "command",
            "command": "cd backend && npm run build",
            "expected": "Build successful"
          },
          "status": "pending",
          "notes": "Functions: calculateWeeklyRankings(), calculateAllTimeRankings(), getWeekStartDate(). Filter by parent_id and leaderboard_enabled."
        },
        {
          "id": "subtask-2-2",
          "description": "Add GET /api/children/leaderboard endpoint",
          "service": "backend",
          "files_to_modify": ["backend/src/routes/children.ts"],
          "files_to_create": [],
          "patterns_from": ["backend/src/routes/children.ts"],
          "verification": {
            "type": "api",
            "method": "GET",
            "url": "http://localhost:6001/api/children/leaderboard?timeframe=weekly",
            "expected_status": 200
          },
          "status": "pending",
          "notes": "Query param: timeframe (weekly|alltime). Returns rankings array with child name, coins, rank. Use authenticateChild middleware."
        },
        {
          "id": "subtask-2-3",
          "description": "Add PUT /api/children/:id/leaderboard-status endpoint",
          "service": "backend",
          "files_to_modify": ["backend/src/routes/children.ts"],
          "files_to_create": [],
          "patterns_from": ["backend/src/routes/children.ts"],
          "verification": {
            "type": "api",
            "method": "PUT",
            "url": "http://localhost:6001/api/children/{id}/leaderboard-status",
            "expected_status": 200
          },
          "status": "pending",
          "notes": "Body: { enabled: boolean }. Use authenticateParent middleware. Verify child belongs to parent."
        }
      ]
    },
    {
      "id": "phase-3-backend-challenges",
      "name": "Backend Challenge Service",
      "type": "implementation",
      "description": "Create family challenge service for tracking and reward distribution",
      "depends_on": ["phase-1-database"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create challengeService.ts with challenge logic",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["backend/src/services/challengeService.ts"],
          "patterns_from": ["backend/src/routes/collectibles.ts", "backend/src/routes/assignments.ts"],
          "verification": {
            "type": "command",
            "command": "cd backend && npm run build",
            "expected": "Build successful"
          },
          "status": "pending",
          "notes": "Functions: checkFamilyProgress(), completeFamilyChallenge(), distributeBonusRewards(). Use db.transaction() for coin updates."
        },
        {
          "id": "subtask-3-2",
          "description": "Create challenges.ts route file",
          "service": "backend",
          "files_to_modify": ["backend/src/index.ts"],
          "files_to_create": ["backend/src/routes/challenges.ts"],
          "patterns_from": ["backend/src/routes/children.ts"],
          "verification": {
            "type": "command",
            "command": "cd backend && npm run build",
            "expected": "Build successful"
          },
          "status": "pending",
          "notes": "Add GET /api/challenges/family endpoint (authenticateParent). Return active challenges with family progress."
        },
        {
          "id": "subtask-3-3",
          "description": "Add POST /api/challenges/:id/complete endpoint",
          "service": "backend",
          "files_to_modify": ["backend/src/routes/challenges.ts"],
          "files_to_create": [],
          "patterns_from": ["backend/src/routes/collectibles.ts"],
          "verification": {
            "type": "api",
            "method": "POST",
            "url": "http://localhost:6001/api/challenges/{id}/complete",
            "expected_status": 200
          },
          "status": "pending",
          "notes": "Check if family reached goal. Use transaction to: mark complete, award bonus coins to all opted-in children."
        },
        {
          "id": "subtask-3-4",
          "description": "Seed initial family challenges",
          "service": "backend",
          "files_to_modify": ["backend/src/data/schema.sql"],
          "files_to_create": [],
          "patterns_from": ["backend/src/data/schema.sql"],
          "verification": {
            "type": "command",
            "command": "cd backend && sqlite3 ../data/teacher.db 'SELECT COUNT(*) FROM family_challenges'",
            "expected": "1 or more"
          },
          "status": "pending",
          "notes": "INSERT seed challenges: 'Weekly Family Goal' (1000 coins, 50 bonus), 'Learning Together' (500 coins, 25 bonus)."
        }
      ]
    },
    {
      "id": "phase-4-frontend-leaderboard",
      "name": "Frontend Leaderboard UI",
      "type": "implementation",
      "description": "Build leaderboard display component and page",
      "depends_on": ["phase-2-backend-leaderboard"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create Leaderboard.tsx component",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": ["frontend/components/Leaderboard.tsx"],
          "patterns_from": ["frontend/components/ui/ProgressChart.tsx"],
          "verification": {
            "type": "command",
            "command": "cd frontend && npm run build",
            "expected": "Build successful"
          },
          "status": "pending",
          "notes": "Props: rankings, timeframe, onTimeframeChange. Display ranked list with child names, coins, rank badges. Use Tailwind."
        },
        {
          "id": "subtask-4-2",
          "description": "Create leaderboard page at app/child/leaderboard/page.tsx",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": ["frontend/app/child/leaderboard/page.tsx"],
          "patterns_from": ["frontend/app/child/page.tsx"],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/child/leaderboard",
            "checks": ["Page renders", "Toggle weekly/all-time", "Rankings display"]
          },
          "status": "pending",
          "notes": "Fetch from /api/children/leaderboard. Toggle between weekly/alltime. Show 'Week of [date]' for weekly."
        },
        {
          "id": "subtask-4-3",
          "description": "Add leaderboard API methods to lib/api.ts",
          "service": "frontend",
          "files_to_modify": ["frontend/lib/api.ts"],
          "files_to_create": [],
          "patterns_from": ["frontend/lib/api.ts"],
          "verification": {
            "type": "command",
            "command": "cd frontend && npm run build",
            "expected": "Build successful"
          },
          "status": "pending",
          "notes": "Add children.getLeaderboard(token, timeframe) and children.updateLeaderboardStatus(token, childId, enabled) methods."
        }
      ]
    },
    {
      "id": "phase-5-frontend-parent-controls",
      "name": "Frontend Parent Controls",
      "type": "implementation",
      "description": "Add parent settings UI for leaderboard opt-in/opt-out per child",
      "depends_on": ["phase-2-backend-leaderboard"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Add leaderboard toggles to parent children list",
          "service": "frontend",
          "files_to_modify": ["frontend/app/parent/page.tsx"],
          "files_to_create": [],
          "patterns_from": ["frontend/app/parent/page.tsx"],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/parent",
            "checks": ["Toggles visible per child", "Toggle updates status", "No console errors"]
          },
          "status": "pending",
          "notes": "Add toggle switch for each child. Call PUT /api/children/:id/leaderboard-status on change."
        }
      ]
    },
    {
      "id": "phase-6-frontend-challenges",
      "name": "Frontend Challenge Display",
      "type": "implementation",
      "description": "Build family challenge display showing progress and rewards",
      "depends_on": ["phase-3-backend-challenges"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Create FamilyChallenges.tsx component",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": ["frontend/components/FamilyChallenges.tsx"],
          "patterns_from": ["frontend/components/ui/ProgressChart.tsx"],
          "verification": {
            "type": "command",
            "command": "cd frontend && npm run build",
            "expected": "Build successful"
          },
          "status": "pending",
          "notes": "Display active challenges with progress bars. Show current/goal amounts, bonus reward. Use Tailwind."
        },
        {
          "id": "subtask-6-2",
          "description": "Add family challenges to leaderboard page",
          "service": "frontend",
          "files_to_modify": ["frontend/app/child/leaderboard/page.tsx"],
          "files_to_create": [],
          "patterns_from": ["frontend/app/child/leaderboard/page.tsx"],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/child/leaderboard",
            "checks": ["Challenges visible", "Progress bars show correctly", "Bonus amounts display"]
          },
          "status": "pending",
          "notes": "Fetch challenges from /api/challenges/family. Render FamilyChallenges component above leaderboard."
        },
        {
          "id": "subtask-6-3",
          "description": "Add challenges API methods to lib/api.ts",
          "service": "frontend",
          "files_to_modify": ["frontend/lib/api.ts"],
          "files_to_create": [],
          "patterns_from": ["frontend/lib/api.ts"],
          "verification": {
            "type": "command",
            "command": "cd frontend && npm run build",
            "expected": "Build successful"
          },
          "status": "pending",
          "notes": "Add challenges.listFamily(token) method to fetch active family challenges."
        }
      ]
    },
    {
      "id": "phase-7-integration",
      "name": "Integration & Testing",
      "type": "integration",
      "description": "End-to-end verification of leaderboard and challenge flows",
      "depends_on": ["phase-4-frontend-leaderboard", "phase-5-frontend-parent-controls", "phase-6-frontend-challenges"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-7-1",
          "description": "Test parent opt-in/opt-out flow",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Login as parent",
              "Enable leaderboard for child A",
              "Disable leaderboard for child B",
              "Login as child A - verify leaderboard visible",
              "Login as child B - verify leaderboard not visible or shows opt-out message"
            ]
          },
          "status": "pending",
          "notes": "Verify parent controls work correctly and children see appropriate UI"
        },
        {
          "id": "subtask-7-2",
          "description": "Test privacy enforcement (family boundary)",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Create two parent accounts (Family A, Family B)",
              "Add children to each family",
              "Login as Family A child",
              "Verify leaderboard shows only Family A children",
              "Login as Family B child",
              "Verify leaderboard shows only Family B children"
            ]
          },
          "status": "pending",
          "notes": "Critical privacy test - ensure no cross-family data leakage"
        },
        {
          "id": "subtask-7-3",
          "description": "Test weekly vs all-time rankings",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Login as child",
              "View weekly leaderboard - verify Week of [date] header",
              "Toggle to all-time - verify cumulative coins display",
              "Complete assignment earning coins",
              "Verify weekly ranking updates"
            ]
          },
          "status": "pending",
          "notes": "Verify timeframe toggle and ranking calculations work correctly"
        },
        {
          "id": "subtask-7-4",
          "description": "Test family challenge completion and rewards",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Create family with 2+ children opted in",
              "Complete assignments to reach challenge goal",
              "Verify challenge marked complete",
              "Verify bonus coins awarded to all opted-in children",
              "Verify opted-out children do not receive bonus"
            ]
          },
          "status": "pending",
          "notes": "Test collaborative challenge flow and bonus distribution"
        }
      ]
    }
  ],

  "summary": {
    "total_phases": 7,
    "total_subtasks": 24,
    "services_involved": ["backend", "frontend"],
    "parallelism": {
      "max_parallel_phases": 3,
      "parallel_groups": [
        {
          "phases": ["phase-2-backend-leaderboard", "phase-3-backend-challenges"],
          "reason": "Both depend only on phase-1-database, different file sets, can run concurrently"
        },
        {
          "phases": ["phase-4-frontend-leaderboard", "phase-5-frontend-parent-controls", "phase-6-frontend-challenges"],
          "reason": "Frontend phases depend on different backend phases but don't conflict on files"
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.6x faster than sequential (3 parallel groups reduce critical path)"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 003 --parallel 2"
  },

  "verification_strategy": {
    "risk_level": "high",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": ["unit", "integration", "e2e"],
    "security_scanning_required": true,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "New leaderboard and challenge tests pass",
      "Privacy boundaries enforced (family-only data)",
      "Parent-only controls verified",
      "No cross-family data leakage",
      "Database migrations complete successfully"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests - Backend",
        "command": "cd backend && npm test",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Unit Tests - Frontend",
        "command": "cd frontend && npm test",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests - Leaderboard API",
        "command": "cd backend && npm test -- leaderboard",
        "expected_outcome": "Leaderboard endpoints return correct data",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Security Scan - Privacy Checks",
        "command": "python auto-claude/scan_secrets.py --all-files --json",
        "expected_outcome": "No secrets detected, privacy filters verified",
        "type": "security",
        "required": true,
        "blocking": true
      },
      {
        "name": "Browser Verification - Leaderboard",
        "command": "manual",
        "expected_outcome": "Leaderboard page renders, toggles work, no console errors",
        "type": "manual",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "High risk due to privacy-sensitive feature requiring authorization checks, database schema changes, and cross-family isolation. E2E tests critical for verifying family boundaries."
  },

  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["cd backend && npm test", "cd frontend && npm test"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["cd backend && npm test -- leaderboard", "cd backend && npm test -- challenges"],
      "services_to_test": ["backend"]
    },
    "e2e_tests": {
      "required": true,
      "commands": [],
      "flows": ["parent-opt-in-out", "child-view-leaderboard", "family-challenge-complete", "privacy-enforcement"]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000/child/leaderboard",
          "checks": ["renders", "no-console-errors", "toggle-works", "rankings-display"]
        },
        {
          "url": "http://localhost:3000/parent",
          "checks": ["renders", "leaderboard-toggles-visible", "toggle-updates-status"]
        }
      ]
    },
    "database_verification": {
      "required": true,
      "checks": [
        "leaderboard_enabled column exists in children table",
        "family_challenges table exists",
        "family_challenge_progress table exists",
        "indexes on (parent_id, leaderboard_enabled) exist",
        "seed challenges inserted"
      ]
    }
  },

  "qa_signoff": null
}
